<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sabeco App Service - Students Management</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
            }

            .container {
                max-width: 800px;
                margin: 0 auto;
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h1 {
                color: #333;
                text-align: center;
                margin-bottom: 30px;
            }

            .loading {
                text-align: center;
                color: #666;
                font-style: italic;
            }

            .error {
                background-color: #f8d7da;
                color: #721c24;
                padding: 15px;
                border-radius: 5px;
                margin: 20px 0;
            }

            .tables-list {
                list-style: none;
                padding: 0;
            }

            .table-item {
                background-color: #f8f9fa;
                margin: 10px 0;
                padding: 15px;
                border-left: 4px solid #007bff;
                border-radius: 4px;
                transition: background-color 0.3s;
            }

            .table-item:hover {
                background-color: #e9ecef;
            }

            .table-name {
                font-weight: bold;
                color: #007bff;
                font-size: 16px;
            }

            .refresh-btn {
                background-color: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                margin-top: 20px;
            }

            .refresh-btn:hover {
                background-color: #0056b3;
            }

            .status {
                text-align: center;
                margin: 20px 0;
            }

            .tabs {
                display: flex;
                margin-bottom: 20px;
                border-bottom: 2px solid #dee2e6;
            }

            .tab {
                background: none;
                border: none;
                padding: 10px 20px;
                cursor: pointer;
                font-size: 16px;
                color: #666;
                border-bottom: 2px solid transparent;
                transition: all 0.3s;
            }

            .tab.active {
                color: #007bff;
                border-bottom-color: #007bff;
                font-weight: bold;
            }

            .tab:hover {
                color: #007bff;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .student-form {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #333;
            }

            .form-group input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                box-sizing: border-box;
            }

            .form-group input:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            }

            .add-btn {
                background-color: #28a745;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            }

            .add-btn:hover {
                background-color: #218838;
            }

            .students-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            .students-table th,
            .students-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #ddd;
            }

            .students-table th {
                background-color: #f8f9fa;
                font-weight: bold;
                color: #333;
            }

            .students-table tr:hover {
                background-color: #f5f5f5;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Sabeco App Service - Students Management</h1>

            <div class="tabs">
                <button class="tab active" onclick="showTab('tables')">
                    Database Tables
                </button>
                <button class="tab" onclick="showTab('students')">
                    Quản lý Học sinh
                </button>
            </div>

            <div id="tablesContent" class="tab-content active">
                <div id="status" class="status">
                    <div class="loading">Đang tải danh sách bảng...</div>
                </div>
                <ul id="tablesList" class="tables-list"></ul>
                <button
                    id="refreshBtn"
                    class="refresh-btn"
                    onclick="loadTables()"
                >
                    Làm mới Tables
                </button>
            </div>

            <div id="studentsContent" class="tab-content">
                <div class="student-form">
                    <h3>Thêm học sinh mới</h3>
                    <form id="studentForm">
                        <div class="form-group">
                            <label for="studentName">Họ tên:</label>
                            <input
                                type="text"
                                id="studentName"
                                name="name"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="studentAge">Tuổi:</label>
                            <input
                                type="number"
                                id="studentAge"
                                name="age"
                                min="1"
                                max="100"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="studentCity">Thành phố:</label>
                            <input
                                type="text"
                                id="studentCity"
                                name="city"
                                required
                            />
                        </div>
                        <button type="submit" class="add-btn">
                            Thêm học sinh
                        </button>
                    </form>
                </div>

                <div id="studentsStatus" class="status">
                    <div class="loading">Đang tải danh sách học sinh...</div>
                </div>

                <table
                    id="studentsTable"
                    class="students-table"
                    style="display: none"
                >
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Họ tên</th>
                            <th>Tuổi</th>
                            <th>Thành phố</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody"></tbody>
                </table>

                <button
                    id="refreshStudentsBtn"
                    class="refresh-btn"
                    onclick="loadStudents()"
                >
                    Làm mới Students
                </button>
            </div>
        </div>

        <script>
            // Tab functionality
            function showTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll(".tab-content").forEach((content) => {
                    content.classList.remove("active");
                });

                // Remove active class from all tabs
                document.querySelectorAll(".tab").forEach((tab) => {
                    tab.classList.remove("active");
                });

                // Show selected tab content
                if (tabName === "tables") {
                    document
                        .getElementById("tablesContent")
                        .classList.add("active");
                    document
                        .querySelector(".tab:first-child")
                        .classList.add("active");
                } else if (tabName === "students") {
                    document
                        .getElementById("studentsContent")
                        .classList.add("active");
                    document
                        .querySelector(".tab:last-child")
                        .classList.add("active");
                    loadStudents();
                }
            }

            async function loadTables() {
                const statusDiv = document.getElementById("status");
                const tablesList = document.getElementById("tablesList");

                statusDiv.innerHTML =
                    '<div class="loading">Đang tải danh sách bảng...</div>';
                tablesList.innerHTML = "";

                try {
                    console.log("Fetching tables from API...");
                    const response = await fetch("/api/tables");
                    const data = await response.json();

                    console.log("API Response:", {
                        status: response.status,
                        data,
                    });

                    if (!response.ok) {
                        throw new Error(
                            data.details
                                ? `${data.error}: ${data.details}`
                                : data.error || "Có lỗi xảy ra"
                        );
                    }

                    if (data.length === 0) {
                        statusDiv.innerHTML =
                            '<div class="error">Không tìm thấy bảng nào trong database.</div>';
                        return;
                    }

                    statusDiv.innerHTML = `<div style="color: #28a745;">Tìm thấy ${data.length} bảng trong database.</div>`;

                    data.forEach((table) => {
                        const li = document.createElement("li");
                        li.className = "table-item";
                        li.innerHTML = `<div class="table-name">${table.name}</div>`;
                        tablesList.appendChild(li);
                    });
                } catch (error) {
                    console.error("Error loading tables:", error);
                    statusDiv.innerHTML = `<div class="error">Lỗi kết nối database: ${error.message}</div>`;
                }
            }

            async function loadStudents() {
                const statusDiv = document.getElementById("studentsStatus");
                const table = document.getElementById("studentsTable");
                const tbody = document.getElementById("studentsTableBody");

                statusDiv.innerHTML =
                    '<div class="loading">Đang tải danh sách học sinh...</div>';
                table.style.display = "none";
                tbody.innerHTML = "";

                try {
                    console.log("Fetching students from API...");
                    const response = await fetch("/api/students");
                    const data = await response.json();

                    console.log("Students API Response:", {
                        status: response.status,
                        data,
                    });

                    if (!response.ok) {
                        throw new Error(
                            data.details
                                ? `${data.error}: ${data.details}`
                                : data.error || "Có lỗi xảy ra"
                        );
                    }

                    if (data.length === 0) {
                        statusDiv.innerHTML =
                            '<div style="color: #ffc107;">Chưa có học sinh nào trong database. Hãy thêm học sinh đầu tiên!</div>';
                        return;
                    }

                    statusDiv.innerHTML = `<div style="color: #28a745;">Tìm thấy ${data.length} học sinh.</div>`;
                    table.style.display = "table";

                    data.forEach((student) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${student.Id}</td>
                            <td>${student.Name || "N/A"}</td>
                            <td>${student.Age || "N/A"}</td>
                            <td>${student.City || "N/A"}</td>
                        `;
                        tbody.appendChild(row);
                    });
                } catch (error) {
                    console.error("Error loading students:", error);
                    statusDiv.innerHTML = `<div class="error">Lỗi kết nối database: ${error.message}</div>`;
                }
            }

            async function addStudent(event) {
                event.preventDefault();

                const form = document.getElementById("studentForm");
                const formData = new FormData(form);
                const studentData = {
                    name: formData.get("name"),
                    age: formData.get("age"),
                    city: formData.get("city"),
                };

                console.log("Submitting student data:", studentData);

                try {
                    const response = await fetch("/api/students", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(studentData),
                    });

                    const result = await response.json();
                    console.log("Add student response:", {
                        status: response.status,
                        result,
                    });

                    if (!response.ok) {
                        throw new Error(
                            result.details
                                ? `${result.error}: ${result.details}`
                                : result.error || "Có lỗi xảy ra"
                        );
                    }

                    alert(`Thêm học sinh thành công! ID: ${result.id}`);
                    form.reset();
                    loadStudents();
                } catch (error) {
                    console.error("Error adding student:", error);
                    alert("Lỗi thêm học sinh: " + error.message);
                }
            }

            // Event listeners
            document
                .getElementById("studentForm")
                .addEventListener("submit", addStudent);

            // Load tables when page loads
            window.addEventListener("load", loadTables);
        </script>
    </body>
</html>
